<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>File Handling Project</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">

  <h1 class="text-3xl font-bold text-center text-blue-600 mb-6">File Management System</h1>

  
  <div class="bg-white p-4 rounded-2xl shadow-md mb-6">
    <h2 class="text-xl font-semibold mb-2">Upload File</h2>
    <input type="file" id="uploadFile" class="mb-2">
    <button onclick="uploadFile()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
      Upload
    </button>
  </div>

  
  <div class="bg-white p-4 rounded-2xl shadow-md">
    <h2 class="text-xl font-semibold mb-2">All Files</h2>
    <button onclick="fetchFiles()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 mb-3">
      Refresh List
    </button>

    <table class="w-full border-collapse border border-gray-300">
      <thead>
        <tr class="bg-gray-200">
          <th class="border p-2">Name</th>
          <th class="border p-2">Type</th>
          <th class="border p-2">Size</th>
          <th class="border p-2">Actions</th>
        </tr>
      </thead>
      <tbody id="fileTableBody"></tbody>
    </table>

    <button onclick="downloadAllZip()" class="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600 mt-4">
      Download All as ZIP
    </button>
  </div>


  <div id="videoModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white p-4 rounded-2xl shadow-lg max-w-3xl w-full relative">
      <button onclick="closeVideoModal()" class="absolute top-2 right-2 text-red-500 font-bold text-lg">&times;</button>
      <video id="videoPlayer" class="w-full rounded-lg" controls></video>
    </div>
  </div>

  <script>
    const API_URL = "http://localhost:8080/file";

    async function uploadFile() {
      const fileInput = document.getElementById("uploadFile");
      if (!fileInput.files.length) return alert("Please select a file");

      const formData = new FormData();
      formData.append("file", fileInput.files[0]);

      try {
        const res = await fetch(`${API_URL}/upload`, {
          method: "POST",
          body: formData,
        });

        if (res.ok) {
          alert("File uploaded successfully");
          fetchFiles();
        } else alert("Failed to upload file");
      } catch (error) {
        console.error(error);
        alert("Error uploading file");
      }
    }

    async function fetchFiles() {
      try {
        const res = await fetch(`${API_URL}/files/metadata`);
        const files = await res.json();

        const tableBody = document.getElementById("fileTableBody");
        tableBody.innerHTML = "";

        files.forEach((file) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td class="border p-2">${file.name}</td>
            <td class="border p-2">${file.type}</td>
            <td class="border p-2">${(file.size / 1024).toFixed(2)} KB</td>
            <td class="border p-2 flex gap-2 flex-wrap">
              <button onclick="downloadStreamFile(${file.id})" class="bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600">Download</button>
              <button onclick="downloadFileAsZip(${file.id})" class="bg-purple-500 text-white px-2 py-1 rounded hover:bg-purple-600">ZIP</button>
              <button onclick="deleteFile(${file.id})" class="bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600">Delete</button>
              ${
                file.type.startsWith("video/")
                  ? `<button onclick="previewVideo(${file.id})" class="bg-green-500 text-white px-2 py-1 rounded hover:bg-green-600">Preview</button>`
                  : ""
              }
              <label class="bg-yellow-500 text-white px-2 py-1 rounded cursor-pointer hover:bg-yellow-600">
                Update <input type="file" style="display:none" onchange="updateFile(${file.id}, this.files[0])">
              </label>
            </td>
          `;
          tableBody.appendChild(row);
        });
      } catch (error) {
        console.error(error);
      }
    }

    async function downloadStreamFile(id) {
  try {
    const response = await fetch(`${API_URL}/stream/download/${id}`);
    if (!response.ok) return alert("File not found");

    // Get file type and name from headers

    const contentType = response.headers.get("Content-Type") || "application/octet-stream";
    const contentDisposition = response.headers.get("Content-Disposition");

    let fileName = "file";
    if (contentDisposition && contentDisposition.includes("filename=")) {
      fileName = contentDisposition.split("filename=")[1].replace(/"/g, "").trim();
    }

    // Stream the file in chunks

    const reader = response.body.getReader();
    const chunks = [];
    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      chunks.push(value);
    }

    const blob = new Blob(chunks, { type: contentType });

    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = fileName;
    link.click();
    URL.revokeObjectURL(link.href);
  } catch (error) {
    console.error(error);
    alert("Error while streaming file");
  }
}


    async function previewVideo(id) {
      const videoPlayer = document.getElementById("videoPlayer");
      videoPlayer.src = `${API_URL}/stream/download/${id}`; // direct streaming URL
      document.getElementById("videoModal").classList.remove("hidden");
    }

    function closeVideoModal() {
      const videoPlayer = document.getElementById("videoPlayer");
      videoPlayer.pause();
      videoPlayer.src = "";
      document.getElementById("videoModal").classList.add("hidden");
    }

    async function downloadFileAsZip(id) {
      const res = await fetch(`${API_URL}/download-zip/${id}`);
      if (res.status === 404) return alert("File not found");
      const blob = await res.blob();
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "file.zip";
      link.click();
    }

    async function downloadAllZip() {
      const res = await fetch(`${API_URL}/download-all`);
      const blob = await res.blob();
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "all_files.zip";
      link.click();
    }

    async function deleteFile(id) {
      if (!confirm("Are you sure you want to delete this file?")) return;
      const res = await fetch(`${API_URL}/${id}`, { method: "DELETE" });
      if (res.ok) {
        alert("File deleted");
        fetchFiles();
      } else alert("Failed to delete file");
    }

    async function updateFile(id, file) {
      const formData = new FormData();
      formData.append("file", file);

      const res = await fetch(`${API_URL}/${id}`, {
        method: "PUT",
        body: formData,
      });

      if (res.ok) {
        alert("File updated successfully");
        fetchFiles();
      } else alert("Failed to update file");
    }

    fetchFiles();
  </script>
</body>
</html>
